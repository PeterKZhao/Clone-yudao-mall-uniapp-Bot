name: Create and init UniApp Mall repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "è¦åˆ›å»ºçš„æ–° GitHub ä»“åº“åï¼ˆä¾‹å¦‚: future-mall-uniappï¼‰"
        required: true
        default: "future-mall-uniapp"
      repo_description:
        description: "ä»“åº“æè¿°"
        required: false
        default: "Init from Gitee yudao-mall-uniapp"
      private:
        description: "æ˜¯å¦åˆ›å»ºä¸ºç§æœ‰ä»“åº“ (true/false)"
        required: false
        default: "false"

jobs:
  create-and-init:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      OWNER: PeterKZhao
      NEW_REPO: ${{ github.event.inputs.repo_name }}
      REPO_DESC: ${{ github.event.inputs.repo_description }}
      PRIVATE: ${{ github.event.inputs.private }}

    steps:
      - name: Checkout Clone-Bot
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: pip install -q -r tools/requirements.txt

      - name: Delete existing repo if exists
        shell: bash
        run: |
          set -euo pipefail
          CODE="$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${NEW_REPO}")"

          if [ "${CODE}" = "200" ]; then
            curl -sS -o /dev/null -X DELETE \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${OWNER}/${NEW_REPO}"
            echo "ğŸ—‘ï¸ å·²åˆ é™¤æ—§ä»“åº“ï¼Œç­‰å¾… 3s..."
            sleep 3
          fi

      - name: Clone from Gitee
        shell: bash
        run: |
          set -euo pipefail
          git clone -q --depth=1 --single-branch \
            https://gitee.com/yudaocode/yudao-mall-uniapp.git source

          rm -rf source/.git source/.gitee source/.github \
                 source/README.md source/README-zh_CN.md

      - name: Convert HBuilderX project to CLI
        shell: bash
        run: |
          set -euo pipefail
          (cd source && python3 ../tools/convert_hbx_to_cli.py)

      - name: Replace text content
        shell: bash
        run: |
          set -euo pipefail
          (cd source && python3 ../tools/replace_all.py)

      - name: Copy workflow templates
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p source/.github/workflows
          for tpl in templates/workflows/*.yml; do
            [ -f "$tpl" ] || { echo "ERROR: $tpl not found"; exit 1; }
            cp -f "$tpl" "source/.github/workflows/$(basename "$tpl")"
            echo "  âœ… copied: $(basename "$tpl")"
          done

      - name: Prepare repo content
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p repo_content
          cp -a source/. repo_content/
          rm -rf source

      - name: Create new GitHub repo
        shell: bash
        run: |
          set -euo pipefail

          PRIVATE_BOOL=$( [ "${PRIVATE}" = "true" ] && echo true || echo false )

          RESP="$(curl -sS \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${NEW_REPO}\",
              \"description\": \"${REPO_DESC}\",
              \"private\": ${PRIVATE_BOOL}
            }")"

          if ! echo "${RESP}" | grep -q '"full_name"'; then
            echo "ERROR: Failed to create repo. Response: ${RESP}"
            exit 1
          fi
          sleep 3

      - name: Push to new repo
        shell: bash
        run: |
          set -euo pipefail

          git config --global credential.helper store
          echo "https://${OWNER}:${GH_PAT}@github.com" > ~/.git-credentials

          cd repo_content
          git init -q
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -q -m "Initial commit: æ¢¦å¼€å§‹çš„åœ°æ–¹"
          git branch -M master
          git remote add origin "https://github.com/${OWNER}/${NEW_REPO}.git"
          git push -q -u origin master

          rm -f ~/.git-credentials

      - name: Init gh-pages branch & enable GitHub Pages
        shell: bash
        run: |
          set -euo pipefail

          git config --global credential.helper store
          echo "https://${OWNER}:${GH_PAT}@github.com" > ~/.git-credentials

          # 1. åˆ›å»ºå­¤ç«‹ gh-pages åˆ†æ”¯å¹¶æ¨é€å ä½é¡µ
          #    ï¼ˆGitHub Pages API è¦æ±‚åˆ†æ”¯å¿…é¡»å…ˆå­˜åœ¨ï¼‰
          cd repo_content

          git checkout --orphan gh-pages
          git rm -rf . -q 2>/dev/null || true
          mkdir -p .
          echo '<html><body>Deploying, please wait...</body></html>' > index.html
          git add index.html
          git commit -q -m "Init gh-pages placeholder"
          git push -q origin gh-pages
          git checkout master

          cd ..
          rm -f ~/.git-credentials
          echo "âœ… gh-pages å ä½åˆ†æ”¯å·²æ¨é€"
          sleep 3

          # 2. è°ƒç”¨ GitHub API å¯ç”¨ Pagesï¼ˆæºï¼šgh-pages åˆ†æ”¯æ ¹ç›®å½•ï¼‰
          RESP="$(curl -sS \
            -X POST \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${OWNER}/${NEW_REPO}/pages" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}')"

          if echo "${RESP}" | grep -q '"html_url"'; then
            URL=$(echo "${RESP}" | node -e \
              "let d='';process.stdin.on('data',c=>d+=c);
               process.stdin.on('end',()=>console.log(JSON.parse(d).html_url))")
            echo "âœ… GitHub Pages å·²å¯ç”¨: ${URL}"
          elif echo "${RESP}" | grep -qi 'already\|exists'; then
            echo "âœ… GitHub Pages å·²ç»å¯ç”¨ï¼Œè·³è¿‡"
          else
            echo "âš ï¸  Pages API å“åº”ï¼ˆéè‡´å‘½ï¼‰: ${RESP}"
          fi
