name: Build H5 and Deploy to GitHub Pages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Resolve @dcloudio version & install
        run: |
          npm config set registry https://registry.npmmirror.com

          # npm latest æ ‡ç­¾é”™è¯¯æŒ‡å‘ 2021 å¹´çš„ alpha æ®‹ç¼ºç‰ˆæœ¬
          # å¿…é¡»æ‰‹åŠ¨æŸ¥è¯¢æ‰€æœ‰ç‰ˆæœ¬ï¼Œè¿‡æ»¤å‡ºæ—¥æœŸæ ¼å¼çš„çœŸå®å¯ç”¨ç‰ˆæœ¬ï¼ˆ3.0.0-<13ä½çº¯æ•°å­—>ï¼‰
          DCLOUDIO_VER=$(npm view @dcloudio/vite-plugin-uni versions --json 2>/dev/null | \
            node -e "
            let raw = '';
            process.stdin.on('data', d => raw += d);
            process.stdin.on('end', () => {
              try {
                const vs = JSON.parse(raw);
                const dated = vs.filter(v => /^3\.0\.0-\d{13,}$/.test(v));
                if (dated.length) {
                  dated.sort((a, b) => {
                    const na = BigInt(a.split('-')[1]);
                    const nb = BigInt(b.split('-')[1]);
                    return na < nb ? -1 : na > nb ? 1 : 0;
                  });
                  console.log(dated[dated.length - 1]);
                } else {
                  console.log('3.0.0-3090820231023001');
                }
              } catch(e) {
                console.log('3.0.0-3090820231023001');
              }
            });
            " || echo "3.0.0-3090820231023001")

          echo "ğŸ“Œ @dcloudio resolved: ${DCLOUDIO_VER}"

          # å°† package.json ä¸­æ‰€æœ‰ @dcloudio/*ï¼ˆtypes é™¤å¤–ï¼‰æ›¿æ¢ä¸ºç²¾ç¡®ç‰ˆæœ¬
          node -e "
          const fs = require('fs');
          const ver = process.argv[1];
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          ['dependencies', 'devDependencies'].forEach(key => {
            if (!pkg[key]) return;
            Object.keys(pkg[key]).forEach(name => {
              if (name.startsWith('@dcloudio/') && name !== '@dcloudio/types') {
                pkg[key][name] = ver;
              }
            });
          });
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          console.log('âœ… package.json @dcloudio ç‰ˆæœ¬å·²å›ºå®šä¸º:', ver);
          " "${DCLOUDIO_VER}"

          pnpm install --no-frozen-lockfile

      - name: Ensure manifest.json is in src/
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "src/manifest.json" ]; then
            echo "âœ… src/manifest.json å·²å­˜åœ¨ï¼Œè·³è¿‡"
          elif [ -f "manifest.json" ]; then
            mkdir -p src
            mv manifest.json src/manifest.json
            echo "âœ… manifest.json å·²ç§»è‡³ src/manifest.json"
          else
            echo "âŒ æ‰¾ä¸åˆ° manifest.jsonï¼ˆæ ¹ç›®å½•æˆ– src/ å‡æ— ï¼‰"
            exit 1
          fi

      - name: Set H5 base path in manifest.json
        run: |
          REPO_NAME=$(basename $(git remote get-url origin) .git)
          echo "ğŸ“¦ ä»“åº“å: ${REPO_NAME}ï¼Œè®¾ç½® h5.router.base=/${REPO_NAME}/"

          MANIFEST_PATH="src/manifest.json"

          node -e "
          const fs = require('fs');
          const p = process.argv[1];
          const repoName = process.argv[2];
          const m = JSON.parse(fs.readFileSync(p, 'utf8'));
          m.h5 = m.h5 || {};
          m.h5.router = m.h5.router || {};
          m.h5.router.base = '/' + repoName + '/';
          fs.writeFileSync(p, JSON.stringify(m, null, 2));
          console.log('âœ… h5.router.base =', m.h5.router.base);
          " "${MANIFEST_PATH}" "${REPO_NAME}"

      - name: Build H5
        run: pnpm build:h5

      - name: Verify dist
        run: |
          DIST_DIR="dist/build/h5"
          if [ -d "${DIST_DIR}" ]; then
            echo "âœ… ${DIST_DIR} ç›®å½•å­˜åœ¨"
            ls -lh "${DIST_DIR}/"
          else
            echo "âŒ ${DIST_DIR} æœªæ‰¾åˆ°ï¼ŒH5 ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist/build/h5
          publish_branch: gh-pages
          commit_message: "Deploy H5: ${{ github.sha }}"
