name: Build UniApp â€” Android / iOS / å¾®ä¿¡å°ç¨‹åº

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      platforms:
        description: "æ„å»ºå¹³å°ï¼ˆé€—å·åˆ†éš”ï¼Œå¯é€‰: android,ios,mp-weixinï¼‰"
        required: false
        default: "android,mp-weixin"

env:
  NODE_VERSION: '18'
  PNPM_VERSION: 'latest'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 â–¸ å¾®ä¿¡å°ç¨‹åº
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-mp-weixin:
    name: å¾®ä¿¡å°ç¨‹åº
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build WeChat Mini Program
        run: pnpm build:mp-weixin

      - name: Verify & package output
        run: |
          if [ ! -d "dist/build/mp-weixin" ]; then
            echo "âŒ dist/build/mp-weixin æœªæ‰¾åˆ°"; exit 1
          fi
          echo "âœ… å¾®ä¿¡å°ç¨‹åºæ„å»ºæˆåŠŸ"
          ls -lh dist/build/mp-weixin/
          cd dist/build
          zip -r ../../mp-weixin-${{ github.sha }}.zip mp-weixin/

      - uses: actions/upload-artifact@v4
        with:
          name: mp-weixin-${{ github.sha }}
          path: mp-weixin-${{ github.sha }}.zip
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 â–¸ Android APK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    name: Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      DCLOUD_ANDROID_SDK_URL:  ${{ secrets.DCLOUD_ANDROID_SDK_URL }}
      DCLOUD_APPKEY:           ${{ secrets.DCLOUD_APPKEY }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEY_ALIAS:       ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD:    ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_STORE_PASSWORD:  ${{ secrets.ANDROID_STORE_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build App resources
        run: pnpm build:app

      - name: Verify app resources
        run: |
          if [ ! -d "dist/build/app" ]; then
            echo "âŒ dist/build/app æœªæ‰¾åˆ°"; exit 1
          fi
          echo "âœ… App èµ„æºæ„å»ºæˆåŠŸ"
          ls -lh dist/build/app/

      # æ— è®ºæ˜¯å¦é…ç½®ç¦»çº¿ SDKï¼Œå§‹ç»ˆä¸Šä¼  app èµ„æºä¾›æœ¬åœ° HBuilderX ç¦»çº¿æ‰“åŒ…ä½¿ç”¨
      - uses: actions/upload-artifact@v4
        with:
          name: app-resources-${{ github.sha }}
          path: dist/build/app/
          retention-days: 7

      # â”€â”€ ä»¥ä¸‹æ­¥éª¤éœ€é…ç½® secret: DCLOUD_ANDROID_SDK_URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è¯·å°† DCloud Android ç¦»çº¿æ‰“åŒ… SDK zip ä¸Šä¼ åˆ°å¯è®¿é—®çš„ URL åé…ç½®è¯¥ secret
      # ä¸‹è½½åœ°å€: https://nativesupport.dcloud.net.cn/AppDocs/download/android.html
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download DCloud Android offline SDK
        if: ${{ env.DCLOUD_ANDROID_SDK_URL != '' }}
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ Android ç¦»çº¿ SDK..."
          curl -L -o android-sdk.zip "${{ env.DCLOUD_ANDROID_SDK_URL }}"
          unzip -q android-sdk.zip -d android-sdk
          echo "âœ… SDK è§£å‹å®Œæˆ"
          ls android-sdk/

      - name: Configure AppKey & copy app resources
        if: ${{ env.DCLOUD_ANDROID_SDK_URL != '' }}
        run: |
          APP_ID=$(python3 -c "
          import json
          d = json.load(open('src/manifest.json') if __import__('os').path.exists('src/manifest.json') else open('manifest.json'))
          print(d.get('appid', '__UNI__APPID'))
          ")
          echo "ğŸ†” AppID: ${APP_ID}"

          SIMPLEDEMOSRC="android-sdk/HBuilder-Integrate-AS/simpleDemo/src/main"
          WWW_DIR="${SIMPLEDEMOSRC}/assets/apps/${APP_ID}/www"
          mkdir -p "${WWW_DIR}"
          cp -r dist/build/app/. "${WWW_DIR}/"
          echo "âœ… App èµ„æºå·²å¤åˆ¶"

          CTRL="${SIMPLEDEMOSRC}/assets/data/dcloud_control.xml"
          [ -f "${CTRL}" ] && sed -i "s/__APPKEY__/${{ env.DCLOUD_APPKEY }}/g" "${CTRL}"

      - name: Setup signing keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ env.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode \
            > android-sdk/HBuilder-Integrate-AS/simpleDemo/release.keystore
          echo "âœ… Keystore å°±ç»ª"

      - uses: actions/cache@v4
        if: ${{ env.DCLOUD_ANDROID_SDK_URL != '' }}
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android-sdk/**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Build APK
        if: ${{ env.DCLOUD_ANDROID_SDK_URL != '' }}
        run: |
          cd android-sdk/HBuilder-Integrate-AS
          chmod +x gradlew
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$(pwd)/simpleDemo/release.keystore" \
            -Pandroid.injected.signing.store.password="${{ env.ANDROID_STORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ env.ANDROID_KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ env.ANDROID_KEY_PASSWORD }}" \
            --no-daemon
          echo "âœ… APK æ„å»ºå®Œæˆ"

      - name: Collect APK
        if: ${{ env.DCLOUD_ANDROID_SDK_URL != '' }}
        run: |
          mkdir -p apk-output
          find android-sdk -name "*.apk" -not -path "*/intermediates/*" \
            -exec cp {} apk-output/ \;
          ls -lh apk-output/

      - uses: actions/upload-artifact@v4
        if: ${{ env.DCLOUD_ANDROID_SDK_URL != '' }}
        with:
          name: android-apk-${{ github.sha }}
          path: apk-output/*.apk
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 â–¸ iOS IPA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-ios:
    name: iOS IPA
    runs-on: macos-latest
    timeout-minutes: 60

    env:
      DCLOUD_IOS_SDK_URL:       ${{ secrets.DCLOUD_IOS_SDK_URL }}
      DCLOUD_APPKEY:            ${{ secrets.DCLOUD_APPKEY }}
      IOS_CERTIFICATE_BASE64:   ${{ secrets.IOS_CERTIFICATE_BASE64 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_PROVISION_BASE64:     ${{ secrets.IOS_PROVISION_BASE64 }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build App resources
        run: pnpm build:app

      - name: Verify app resources
        run: |
          if [ ! -d "dist/build/app" ]; then
            echo "âŒ dist/build/app æœªæ‰¾åˆ°"; exit 1
          fi
          echo "âœ… App èµ„æºæ„å»ºæˆåŠŸ"

      # å§‹ç»ˆä¸Šä¼  app èµ„æº
      - uses: actions/upload-artifact@v4
        with:
          name: app-resources-ios-${{ github.sha }}
          path: dist/build/app/
          retention-days: 7

      # â”€â”€ ä»¥ä¸‹æ­¥éª¤éœ€é…ç½® DCLOUD_IOS_SDK_URL + IOS_* secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ä¸‹è½½åœ°å€: https://nativesupport.dcloud.net.cn/AppDocs/download/ios.html
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download DCloud iOS offline SDK
        if: ${{ env.DCLOUD_IOS_SDK_URL != '' }}
        run: |
          curl -L -o ios-sdk.zip "${{ env.DCLOUD_IOS_SDK_URL }}"
          unzip -q ios-sdk.zip -d ios-sdk
          echo "âœ… iOS SDK è§£å‹å®Œæˆ"

      - name: Copy app resources to iOS project
        if: ${{ env.DCLOUD_IOS_SDK_URL != '' }}
        run: |
          APP_ID=$(python3 -c "
          import json, os
          p = 'src/manifest.json' if os.path.exists('src/manifest.json') else 'manifest.json'
          d = json.load(open(p))
          print(d.get('appid', '__UNI__APPID'))
          ")
          echo "ğŸ†” AppID: ${APP_ID}"

          IOS_WWW="ios-sdk/HBuilder-Hello/HBuilder-Hello/Pandora/apps/${APP_ID}/www"
          mkdir -p "${IOS_WWW}"
          cp -r dist/build/app/. "${IOS_WWW}/"
          echo "âœ… App èµ„æºå·²å¤åˆ¶åˆ° iOS é¡¹ç›®"

      - name: Import certificate & provisioning profile
        if: ${{ env.IOS_CERTIFICATE_BASE64 != '' }}
        run: |
          CERT_PATH=$RUNNER_TEMP/cert.p12
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app.keychain-db

          echo -n "${{ env.IOS_CERTIFICATE_BASE64 }}"  | base64 --decode -o "$CERT_PATH"
          echo -n "${{ env.IOS_PROVISION_BASE64 }}"    | base64 --decode -o "$PP_PATH"

          security create-keychain -p "ci_keychain_pwd" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "ci_keychain_pwd" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "${{ env.IOS_CERTIFICATE_PASSWORD }}" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "âœ… è¯ä¹¦å’Œæè¿°æ–‡ä»¶å¯¼å…¥å®Œæˆ"

      - name: Build & archive
        if: ${{ env.DCLOUD_IOS_SDK_URL != '' && env.IOS_CERTIFICATE_BASE64 != '' }}
        run: |
          cd ios-sdk/HBuilder-Hello
          xcodebuild \
            -project HBuilder-Hello.xcodeproj \
            -scheme HBuilder-Hello \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/HBuilder.xcarchive" \
            archive
          echo "âœ… Archive å®Œæˆ"

      - name: Export IPA
        if: ${{ env.DCLOUD_IOS_SDK_URL != '' && env.IOS_CERTIFICATE_BASE64 != '' }}
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/HBuilder.xcarchive" \
            -exportOptionsPlist "ios-sdk/HBuilder-Hello/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/ipa"
          echo "âœ… IPA å¯¼å‡ºå®Œæˆ"
          ls -lh "$RUNNER_TEMP/ipa/"

      - uses: actions/upload-artifact@v4
        if: ${{ env.DCLOUD_IOS_SDK_URL != '' && env.IOS_CERTIFICATE_BASE64 != '' }}
        with:
          name: ios-ipa-${{ github.sha }}
          path: ${{ runner.temp }}/ipa/*.ipa
          retention-days: 7
