name: Build UniApp â€” Android / iOS / å¾®ä¿¡å°ç¨‹åº

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      platforms:
        description: "æ„å»ºå¹³å°ï¼ˆé€—å·åˆ†éš”ï¼Œå¯é€‰: android,ios,mp-weixinï¼‰"
        required: false
        default: "android,mp-weixin"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¬å…±ç¯å¢ƒå˜é‡ï¼ˆåœ¨å„ job ä¸­å¼•ç”¨ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  NODE_VERSION: '18'
  PNPM_VERSION: 'latest'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 â–¸ å¾®ä¿¡å°ç¨‹åº
  # äº§å‡ºï¼šunpackage/dist/build/mp-weixinï¼ˆzip æ‰“åŒ…ï¼‰
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-mp-weixin:
    name: å¾®ä¿¡å°ç¨‹åº
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build WeChat Mini Program
        run: pnpm build:mp-weixin

      - name: Verify output
        run: |
          if [ ! -d "unpackage/dist/build/mp-weixin" ]; then
            echo "âŒ mp-weixin æ„å»ºç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi
          echo "âœ… mp-weixin æ„å»ºæˆåŠŸ"
          ls -lh unpackage/dist/build/mp-weixin/

      - name: Package mp-weixin output
        run: |
          cd unpackage/dist/build
          zip -r ../../../mp-weixin-${{ github.sha }}.zip mp-weixin/
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ: mp-weixin-${{ github.sha }}.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mp-weixin-${{ github.sha }}
          path: mp-weixin-${{ github.sha }}.zip
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 â–¸ Android APK
  # äº§å‡ºï¼š
  #   - app èµ„æºåŒ…ï¼ˆæ— è®ºæ˜¯å¦é…ç½® SDK éƒ½ä¼šè¾“å‡ºï¼‰
  #   - APKï¼ˆéœ€é…ç½® DCLOUD_ANDROID_SDK_URL + ANDROID_KEYSTORE_* secretsï¼‰
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    name: Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build App resources
        run: pnpm build:app

      - name: Verify app resources
        run: |
          if [ ! -d "unpackage/dist/build/app" ]; then
            echo "âŒ app æ„å»ºç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi
          echo "âœ… App èµ„æºæ„å»ºæˆåŠŸ"
          ls -lh unpackage/dist/build/app/

      # â”€â”€ ä»¥ä¸‹æ­¥éª¤éœ€è¦é…ç½® secret: DCLOUD_ANDROID_SDK_URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è¯·æå‰å°† DCloud Android ç¦»çº¿æ‰“åŒ… SDKï¼ˆzipï¼‰ä¸Šä¼ åˆ°å¯è®¿é—®çš„ URL
      # ä¸‹è½½åœ°å€: https://nativesupport.dcloud.net.cn/AppDocs/download/android.html
      # å»ºè®®å­˜å‚¨åœ¨: GitHub Release Assets / é˜¿é‡Œäº‘ OSS / è…¾è®¯äº‘ COS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download DCloud Android offline SDK
        if: ${{ secrets.DCLOUD_ANDROID_SDK_URL != '' }}
        run: |
          set -euo pipefail
          echo "â¬‡ï¸ ä¸‹è½½ DCloud Android ç¦»çº¿æ‰“åŒ… SDK..."
          curl -L -o android-sdk.zip "${{ secrets.DCLOUD_ANDROID_SDK_URL }}"
          unzip -q android-sdk.zip -d android-sdk
          echo "âœ… SDK è§£å‹å®Œæˆ"
          ls android-sdk/

      - name: Configure AppKey and copy app resources
        if: ${{ secrets.DCLOUD_ANDROID_SDK_URL != '' }}
        env:
          DCLOUD_APPKEY: ${{ secrets.DCLOUD_APPKEY }}
        run: |
          set -euo pipefail

          # è¯»å– manifest.json ä¸­çš„ appidï¼ˆ__UNI__XXXXXXX æ ¼å¼ï¼‰
          APP_ID=$(cat manifest.json | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          print(d.get('appid','__UNI__APPID'))
          ")
          echo "ğŸ†” AppID: ${APP_ID}"

          # DCloud Android SDK æ¨¡æ¿é¡¹ç›®è·¯å¾„ï¼ˆæ ¹æ®ä¸‹è½½ SDK çš„å®é™…ç›®å½•ç»“æ„è°ƒæ•´ï¼‰
          SIMPLEDEMOSRC="android-sdk/HBuilder-Integrate-AS/simpleDemo/src/main"
          WWW_DIR="${SIMPLEDEMOSRC}/assets/apps/${APP_ID}/www"
          mkdir -p "${WWW_DIR}"
          cp -r unpackage/dist/build/app/. "${WWW_DIR}/"
          echo "âœ… App èµ„æºå·²å¤åˆ¶åˆ°: ${WWW_DIR}"

          # å†™å…¥ AppKeyï¼ˆæ›¿æ¢ dcloud_appkey å ä½ç¬¦ï¼‰
          MANIFEST_SRC="${SIMPLEDEMOSRC}/assets/data/dcloud_control.xml"
          if [ -f "${MANIFEST_SRC}" ]; then
            sed -i "s/__APPKEY__/${DCLOUD_APPKEY}/g" "${MANIFEST_SRC}"
          fi

      - name: Cache Gradle
        if: ${{ secrets.DCLOUD_ANDROID_SDK_URL != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android-sdk/**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Setup signing keystore
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > android-sdk/HBuilder-Integrate-AS/simpleDemo/release.keystore
          echo "âœ… Keystore æ–‡ä»¶å·²å°±ç»ª"

      - name: Build APK (release)
        if: ${{ secrets.DCLOUD_ANDROID_SDK_URL != '' }}
        env:
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          set -euo pipefail
          cd android-sdk/HBuilder-Integrate-AS
          chmod +x gradlew
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$(pwd)/simpleDemo/release.keystore" \
            -Pandroid.injected.signing.store.password="${STORE_PASSWORD}" \
            -Pandroid.injected.signing.key.alias="${KEY_ALIAS}" \
            -Pandroid.injected.signing.key.password="${KEY_PASSWORD}" \
            --no-daemon
          echo "âœ… APK æ„å»ºå®Œæˆ"

      - name: Collect APK
        if: ${{ secrets.DCLOUD_ANDROID_SDK_URL != '' }}
        run: |
          mkdir -p apk-output
          find android-sdk -name "*.apk" -not -path "*/intermediates/*" \
            -exec cp {} apk-output/ \;
          ls -lh apk-output/

      - name: Upload APK artifact
        if: ${{ secrets.DCLOUD_ANDROID_SDK_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.sha }}
          path: apk-output/*.apk
          retention-days: 7

      # æ— è®ºæ˜¯å¦æœ‰ SDKï¼Œå§‹ç»ˆä¸Šä¼  app èµ„æºï¼ˆå¯ç”¨äºæœ¬åœ°ç¦»çº¿æ‰“åŒ…ï¼‰
      - name: Upload app resources artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-resources-${{ github.sha }}
          path: unpackage/dist/build/app/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 â–¸ iOS IPA
  # äº§å‡ºï¼š
  #   - app èµ„æºåŒ…ï¼ˆå§‹ç»ˆè¾“å‡ºï¼‰
  #   - IPAï¼ˆéœ€é…ç½® DCLOUD_IOS_SDK_URL + IOS_* secretsï¼‰
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-ios:
    name: iOS IPA
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build App resources
        run: pnpm build:app

      - name: Verify app resources
        run: |
          if [ ! -d "unpackage/dist/build/app" ]; then
            echo "âŒ app æ„å»ºç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi
          echo "âœ… App èµ„æºæ„å»ºæˆåŠŸ"

      # â”€â”€ ä»¥ä¸‹æ­¥éª¤éœ€è¦é…ç½®ç›¸å…³ secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DCLOUD_IOS_SDK_URL    : DCloud iOS ç¦»çº¿æ‰“åŒ… SDK zip ä¸‹è½½é“¾æ¥
      # IOS_CERTIFICATE_BASE64: .p12 è¯ä¹¦çš„ base64 ç¼–ç 
      # IOS_CERTIFICATE_PASSWORD: .p12 è¯ä¹¦å¯†ç 
      # IOS_PROVISION_BASE64  : .mobileprovision æ–‡ä»¶çš„ base64 ç¼–ç 
      # ä¸‹è½½åœ°å€: https://nativesupport.dcloud.net.cn/AppDocs/download/ios.html
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download DCloud iOS offline SDK
        if: ${{ secrets.DCLOUD_IOS_SDK_URL != '' }}
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ DCloud iOS ç¦»çº¿æ‰“åŒ… SDK..."
          curl -L -o ios-sdk.zip "${{ secrets.DCLOUD_IOS_SDK_URL }}"
          unzip -q ios-sdk.zip -d ios-sdk
          echo "âœ… iOS SDK è§£å‹å®Œæˆ"

      - name: Copy app resources to iOS project
        if: ${{ secrets.DCLOUD_IOS_SDK_URL != '' }}
        run: |
          APP_ID=$(cat manifest.json | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          print(d.get('appid','__UNI__APPID'))
          ")
          echo "ğŸ†” AppID: ${APP_ID}"

          # DCloud iOS SDK æ¨¡æ¿è·¯å¾„ï¼ˆæ ¹æ®å®é™… SDK ç›®å½•ç»“æ„è°ƒæ•´ï¼‰
          IOS_WWW="ios-sdk/HBuilder-Hello/HBuilder-Hello/Pandora/apps/${APP_ID}/www"
          mkdir -p "${IOS_WWW}"
          cp -r unpackage/dist/build/app/. "${IOS_WWW}/"
          echo "âœ… App èµ„æºå·²å¤åˆ¶åˆ° iOS é¡¹ç›®"

      - name: Import signing certificate & provisioning profile
        if: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISION_BASE64: ${{ secrets.IOS_PROVISION_BASE64 }}
        run: |
          CERT_PATH=$RUNNER_TEMP/cert.p12
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app.keychain-db

          echo -n "$IOS_CERTIFICATE_BASE64"  | base64 --decode -o "$CERT_PATH"
          echo -n "$IOS_PROVISION_BASE64"    | base64 --decode -o "$PP_PATH"

          security create-keychain -p "ci_keychain_pwd" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "ci_keychain_pwd" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "âœ… è¯ä¹¦å’Œæè¿°æ–‡ä»¶å¯¼å…¥å®Œæˆ"

      - name: Build & archive with xcodebuild
        if: ${{ secrets.DCLOUD_IOS_SDK_URL != '' && secrets.IOS_CERTIFICATE_BASE64 != '' }}
        run: |
          set -euo pipefail
          cd ios-sdk/HBuilder-Hello

          xcodebuild \
            -project HBuilder-Hello.xcodeproj \
            -scheme HBuilder-Hello \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/HBuilder.xcarchive" \
            archive | xcpretty || xcodebuild \
              -project HBuilder-Hello.xcodeproj \
              -scheme HBuilder-Hello \
              -configuration Release \
              -archivePath "$RUNNER_TEMP/HBuilder.xcarchive" \
              archive

      - name: Export IPA
        if: ${{ secrets.DCLOUD_IOS_SDK_URL != '' && secrets.IOS_CERTIFICATE_BASE64 != '' }}
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/HBuilder.xcarchive" \
            -exportOptionsPlist "ios-sdk/HBuilder-Hello/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/ipa"
          echo "âœ… IPA å¯¼å‡ºæˆåŠŸ"
          ls -lh "$RUNNER_TEMP/ipa/"

      - name: Upload IPA artifact
        if: ${{ secrets.DCLOUD_IOS_SDK_URL != '' && secrets.IOS_CERTIFICATE_BASE64 != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.sha }}
          path: ${{ runner.temp }}/ipa/*.ipa
          retention-days: 7

      # å§‹ç»ˆä¸Šä¼  app èµ„æº
      - name: Upload app resources artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-resources-ios-${{ github.sha }}
          path: unpackage/dist/build/app/
          retention-days: 7
